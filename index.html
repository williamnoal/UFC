import React, { useState, useEffect } from 'react';
import { DndProvider, useDrag, useDrop } from 'react-dnd';
import { HTML5Backend } from 'react-dnd-html5-backend';
import { TouchBackend } from 'react-dnd-touch-backend';
import { MessageSquare, FileText, CheckSquare, Book, Database, Edit, MessageCircle, BarChart2, RefreshCw, Trophy, Info, X } from 'lucide-react';

// --- DATA SOURCE BASED ON PDF ---
const gameData = [
  {
    id: 1,
    description: "Preciso que os alunos construam um texto √∫nico colaborativamente.",
    hint: "A ess√™ncia desta atividade √© ser um documento colaborativo.",
    correctType: "Wiki",
    feedback: "Exato! A Wiki √© ideal para constru√ß√£o coletiva de textos.",
    color: "bg-blue-100 border-blue-500"
  },
  {
    id: 2,
    description: "Quero avaliar submiss√µes individuais de arquivos ou textos online com feedback personalizado.",
    hint: "N√£o permite colabora√ß√£o direta entre estudantes.",
    correctType: "Tarefa",
    feedback: "Perfeito! A Tarefa √© focada na entrega individual e feedback do professor.",
    color: "bg-yellow-100 border-yellow-500"
  },
  {
    id: 3,
    description: "Preciso de uma avalia√ß√£o autom√°tica para quest√µes objetivas.",
    hint: "A configura√ß√£o √© feita em etapas e permite feedback autom√°tico.",
    correctType: "Question√°rio",
    feedback: "Isso! Question√°rios s√£o √≥timos para corre√ß√£o autom√°tica.",
    color: "bg-green-100 border-green-500"
  },
  {
    id: 4,
    description: "Quero criar um dicion√°rio de conceitos constru√≠do pela turma.",
    hint: "Permite compartilhamento de termos e verbetes.",
    correctType: "Gloss√°rio",
    feedback: "Correto! O Gloss√°rio permite construir uma base de conhecimento de termos juntos.",
    color: "bg-purple-100 border-purple-500"
  },
  {
    id: 5,
    description: "Poderosa ferramenta para debates e discuss√µes ass√≠ncronas.",
    hint: "Os estudantes podem discutir um tema e o professor mediar.",
    correctType: "F√≥rum",
    feedback: "Excelente! O F√≥rum √© a principal ferramenta de comunica√ß√£o ass√≠ncrona.",
    color: "bg-indigo-100 border-indigo-500"
  },
  {
    id: 6,
    description: "Compartilhamento de diversos tipos de dados (imagens, links, arquivos) pelos alunos.",
    hint: "Funciona como um reposit√≥rio ou galeria colaborativa.",
    correctType: "Base de Dados",
    feedback: "Muito bem! A Base de Dados √© flex√≠vel para coletar diversos tipos de arquivos.",
    color: "bg-red-100 border-red-500"
  },
  {
    id: 7,
    description: "Comunica√ß√£o s√≠ncrona (tempo real) para tirar d√∫vidas r√°pidas.",
    hint: "N√£o permite nota, o feedback √© feito via conversa.",
    correctType: "Chat",
    feedback: "Certo! O Chat √© ideal para intera√ß√µes imediatas.",
    color: "bg-pink-100 border-pink-500"
  },
  {
    id: 8,
    description: "Coleta de dados para diagn√≥stico sem atribuir nota.",
    hint: "N√£o divulga informa√ß√£o, apenas coleta dados para an√°lise.",
    correctType: "Pesquisa",
    feedback: "Isso mesmo! A Pesquisa √© usada para levantamento de dados e opini√£o.",
    color: "bg-orange-100 border-orange-500"
  }
];

const activityTypes = [
  { name: "F√≥rum", icon: <MessageSquare size={24} />, color: "bg-indigo-500" },
  { name: "Tarefa", icon: <FileText size={24} />, color: "bg-yellow-500" },
  { name: "Question√°rio", icon: <CheckSquare size={24} />, color: "bg-green-600" },
  { name: "Gloss√°rio", icon: <Book size={24} />, color: "bg-purple-500" },
  { name: "Base de Dados", icon: <Database size={24} />, color: "bg-red-500" },
  { name: "Wiki", icon: <Edit size={24} />, color: "bg-blue-500" },
  { name: "Chat", icon: <MessageCircle size={24} />, color: "bg-pink-500" },
  { name: "Pesquisa", icon: <BarChart2 size={24} />, color: "bg-orange-500" },
];

// --- COMPONENTS ---

const DraggableItem = ({ name, icon, color }) => {
  const [{ isDragging }, drag] = useDrag(() => ({
    type: 'ACTIVITY',
    item: { name },
    collect: (monitor) => ({
      isDragging: !!monitor.isDragging(),
    }),
  }));

  return (
    <div
      ref={drag}
      className={`flex flex-col items-center justify-center p-3 m-2 rounded-xl shadow-md cursor-grab transition-transform transform hover:scale-105 active:cursor-grabbing ${color} text-white w-24 h-24 sm:w-28 sm:h-28 opacity-${isDragging ? '50' : '100'}`}
    >
      <div className="mb-2 drop-shadow-md">{icon}</div>
      <span className="text-xs sm:text-sm font-bold text-center leading-tight">{name}</span>
    </div>
  );
};

const DropZone = ({ onDrop, currentCard, feedbackState }) => {
  const [{ isOver }, drop] = useDrop(() => ({
    accept: 'ACTIVITY',
    drop: (item) => onDrop(item.name),
    collect: (monitor) => ({
      isOver: !!monitor.isOver(),
    }),
  }));

  let borderColor = isOver ? 'border-blue-400 bg-blue-50' : 'border-dashed border-gray-300 bg-gray-50';
  let content = <span className="text-gray-400 text-lg font-medium animate-pulse">Arraste a atividade correta aqui</span>;

  if (feedbackState === 'correct') {
    borderColor = 'border-green-500 bg-green-50 scale-105';
    content = (
      <div className="flex flex-col items-center text-green-600 animate-bounce">
        <CheckSquare size={48} />
        <span className="text-xl font-bold mt-2">Correto!</span>
      </div>
    );
  } else if (feedbackState === 'incorrect') {
    borderColor = 'border-red-500 bg-red-50 shake';
    content = (
      <div className="flex flex-col items-center text-red-600">
        <X size={48} />
        <span className="text-xl font-bold mt-2">Tente Novamente</span>
      </div>
    );
  }

  return (
    <div
      ref={drop}
      className={`w-full h-48 sm:h-64 rounded-2xl border-4 flex items-center justify-center transition-all duration-300 ${borderColor}`}
    >
      {content}
    </div>
  );
};

// --- MAIN GAME COMPONENT ---

export default function MoodleMatchGame() {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [feedbackState, setFeedbackState] = useState('idle'); // idle, correct, incorrect
  const [feedbackMessage, setFeedbackMessage] = useState('');
  const [showHint, setShowHint] = useState(false);
  const [isGameOver, setIsGameOver] = useState(false);
  const [shuffledCards, setShuffledCards] = useState([]);
  
  // Detect touch device for backend selection
  const isTouchDevice = () => {
    return (('ontouchstart' in window) ||
      (navigator.maxTouchPoints > 0) ||
      (navigator.msMaxTouchPoints > 0));
  };

  const backend = isTouchDevice() ? TouchBackend : HTML5Backend;

  useEffect(() => {
    restartGame();
  }, []);

  const restartGame = () => {
    const shuffled = [...gameData].sort(() => Math.random() - 0.5);
    setShuffledCards(shuffled);
    setCurrentIndex(0);
    setScore(0);
    setFeedbackState('idle');
    setFeedbackMessage('');
    setShowHint(false);
    setIsGameOver(false);
  };

  const handleDrop = (droppedName) => {
    if (feedbackState === 'correct') return;

    const currentCard = shuffledCards[currentIndex];

    if (droppedName === currentCard.correctType) {
      setFeedbackState('correct');
      setFeedbackMessage(currentCard.feedback);
      setScore(prev => prev + 10);
      
      setTimeout(() => {
        if (currentIndex < shuffledCards.length - 1) {
          setCurrentIndex(prev => prev + 1);
          setFeedbackState('idle');
          setFeedbackMessage('');
          setShowHint(false);
        } else {
          setIsGameOver(true);
        }
      }, 2000);
    } else {
      setFeedbackState('incorrect');
      setFeedbackMessage("Ops! Essa n√£o √© a atividade ideal para este objetivo. Tente outra!");
      setScore(prev => Math.max(0, prev - 2));
      setTimeout(() => setFeedbackState('idle'), 1500);
    }
  };

  if (shuffledCards.length === 0) return null;

  const currentCard = shuffledCards[currentIndex];

  return (
    <DndProvider backend={backend} options={{ enableMouseEvents: true }}>
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-white font-sans text-gray-800 p-4 sm:p-6 flex flex-col items-center">
        
        {/* Header - UFC Identity */}
        <header className="w-full max-w-4xl flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border-l-8 border-yellow-400">
          <div className="flex flex-col">
            <h1 className="text-2xl sm:text-3xl font-extrabold text-blue-900 tracking-tight">MOODLE MATCH</h1>
            <p className="text-xs sm:text-sm text-gray-500 uppercase tracking-widest">Atividades e Objetivos Educacionais</p>
          </div>
          <div className="flex items-center space-x-4">
            <div className="text-right hidden sm:block">
              <span className="block text-xs text-gray-400">PONTUA√á√ÉO</span>
              <span className="text-2xl font-bold text-blue-600">{score}</span>
            </div>
            <div className="bg-blue-100 p-2 rounded-full">
              <Trophy className="text-blue-600" size={24} />
            </div>
          </div>
        </header>

        {isGameOver ? (
          <div className="w-full max-w-2xl bg-white rounded-3xl shadow-xl p-8 text-center animate-fade-in-up">
            <div className="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <Trophy className="text-yellow-500 w-12 h-12" />
            </div>
            <h2 className="text-3xl font-bold text-gray-800 mb-2">Parab√©ns!</h2>
            <p className="text-gray-600 mb-6">Voc√™ completou o ciclo de forma√ß√£o continuada do jogo.</p>
            <div className="text-5xl font-bold text-blue-600 mb-8">{score} <span className="text-xl text-gray-400 font-normal">pontos</span></div>
            <button 
              onClick={restartGame}
              className="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-bold shadow-lg transition-transform transform hover:scale-105 flex items-center mx-auto"
            >
              <RefreshCw className="mr-2" size={20} /> Jogar Novamente
            </button>
          </div>
        ) : (
          <div className="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            {/* Left Column: Challenge Card */}
            <div className="lg:col-span-7 flex flex-col space-y-4">
              
              {/* Progress Bar */}
              <div className="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                <div 
                  className="bg-blue-600 h-2.5 rounded-full transition-all duration-500" 
                  style={{ width: `${((currentIndex) / shuffledCards.length) * 100}%` }}
                ></div>
              </div>

              {/* Card */}
              <div className={`relative bg-white rounded-3xl shadow-xl border-2 p-6 sm:p-10 flex flex-col items-center text-center justify-between min-h-[300px] transition-colors duration-300 ${feedbackState === 'correct' ? 'border-green-400 bg-green-50' : 'border-blue-100'}`}>
                
                <div className="absolute top-4 right-4 text-xs font-bold text-gray-300">
                  {currentIndex + 1} / {shuffledCards.length}
                </div>

                <div className="mb-4">
                   <h3 className="text-gray-400 text-sm font-bold uppercase tracking-wider mb-2">Objetivo Pedag√≥gico</h3>
                   <p className="text-xl sm:text-2xl font-bold text-gray-800 leading-relaxed">
                     "{currentCard.description}"
                   </p>
                </div>

                <DropZone onDrop={handleDrop} currentCard={currentCard} feedbackState={feedbackState} />

                {/* Feedback Text Area */}
                <div className="h-16 mt-4 flex items-center justify-center w-full">
                   {feedbackMessage ? (
                     <p className={`text-center font-medium ${feedbackState === 'correct' ? 'text-green-700' : 'text-red-500'}`}>
                       {feedbackMessage}
                     </p>
                   ) : (
                     !showHint && (
                        <button 
                          onClick={() => { setShowHint(true); setScore(prev => Math.max(0, prev - 5)); }}
                          className="text-sm text-blue-400 hover:text-blue-600 flex items-center transition-colors"
                        >
                          <Info size={16} className="mr-1" /> Precisa de uma dica? (-5 pts)
                        </button>
                     )
                   )}
                   {showHint && !feedbackMessage && (
                     <p className="text-sm text-yellow-600 bg-yellow-50 px-3 py-1 rounded-lg border border-yellow-200 animate-fade-in">
                       üí° Dica: {currentCard.hint}
                     </p>
                   )}
                </div>
              </div>
            </div>

            {/* Right Column: Draggable Items */}
            <div className="lg:col-span-5 bg-white rounded-3xl shadow-lg border border-gray-100 p-4 sm:p-6">
              <h3 className="text-center text-gray-500 font-bold mb-4 uppercase text-sm">Arraste a Atividade</h3>
              <div className="flex flex-wrap justify-center content-start">
                {activityTypes.map((activity) => (
                  <DraggableItem 
                    key={activity.name} 
                    name={activity.name} 
                    icon={activity.icon} 
                    color={activity.color} 
                  />
                ))}
              </div>
            </div>

          </div>
        )}
        
        <footer className="mt-8 text-center text-gray-400 text-xs">
          Baseado no material: "Atividades no Moodle e Seus Objetivos Educacionais" - UFC/SMED
        </footer>
      </div>
    </DndProvider>
  );
}
